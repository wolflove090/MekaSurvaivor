# スタイル効果機能 要件書

## 背景と目的
既存のスタイル変更機能は `CharacterStatsData` の差し替えまで実装済みで、スタイルごとの固有効果（定期回復・移動速度倍率・経験値倍率）は未実装です。  
本対応では、スタイル選択時に対応する効果を自動適用し、スタイルを変更した際は前スタイルの効果を確実に解除して、常に現在スタイルの効果のみが有効な状態を保証します。

## スコープ内
- スタイル変更確定時に、選択スタイルの固有効果を自動適用する。
- スタイル再変更時に、旧スタイル効果を解除して新スタイル効果へ置換する。
- 効果は以下3種類を実装する。
  - 巫女: 30秒ごとにHPを1回復。
  - アイドル: SPDを1.2倍にする。
  - セレブ: 獲得経験値量を2倍にする。
- 効果適用の対象はプレイヤーのみとする。

## 機能要件
1. スタイル効果適用トリガー
- `StyleChangeUiController` によるスタイル選択確定（既存 `TryApplyStyle` 成功時）を起点に、固有効果の適用を行う。
- スタイル未変更時に重複適用しない（同一スタイル再適用でも効果インスタンスは1つを維持）。

2. 排他的適用ルール
- 任意の時点で有効なスタイル効果は1種類のみとする。
- スタイル変更時は「旧効果解除 -> 新効果適用」の順に処理する。
- 解除漏れによる多重効果（例: アイドルSPD倍率が残存したままセレブ効果が有効）を許容しない。

3. 巫女効果（定期回復）
- 有効中、30秒間隔で `HealthComponent.Heal(1)` を実行する。
- 回復は現在HPが最大HP未満のときのみ実際に増加し、最大HPを超えない（`HealthComponent.Heal` の既存仕様に準拠）。
- 巫女から他スタイルへ変更した時点で、以後の定期回復は発生しない。

4. アイドル効果（SPD倍率）
- 有効中、プレイヤーの実効SPDに1.2倍補正を適用する。
- 効果解除時は倍率補正を除去し、基準値（`CharacterStats` 由来のSPD）へ戻す。
- スタイル再変更を繰り返しても倍率の累積誤差が発生しない。

5. セレブ効果（経験値倍率）
- 有効中、`PlayerExperience` 内で経験値倍率を保持し、`AddExperience` 実行時に獲得経験値を2倍として処理する。
- 倍率適用後の経験値は整数として扱い、既存レベルアップ処理（`while` による複数レベルアップ）を維持する。
- セレブから他スタイルへ変更した時点で、経験値倍率は無効化される。

## 非機能要件
- 既存コード規約（暗黙private、`_camelCase`、公開APIへのドキュメントコメント）を順守する。
- 既存責務を尊重し、UI層（`StyleChangeUiController`）に効果ロジックを過度に集約しない。
- 効果切替処理はnull安全で実装し、参照未解決時は警告ログで検出可能にする。
- Updateごとの不要なアロケーションを避ける（タイマー/状態を再利用）。
- `Time.timeScale` が0（UI表示中/停止中）の間は回復タイマーを進めない実装とする。

## 受け入れ条件
- スタイルを巫女に変更後、ゲーム時間30秒経過ごとにHPが1回復する。
- 巫女からアイドルへ変更した直後に巫女の定期回復が停止する。
- アイドル選択中は、同一 `CharacterStatsData` 基準と比較して移動速度が1.2倍になる。
- アイドルから他スタイルへ変更すると移動速度が基準値へ戻る。
- セレブ選択中に経験値1のオーブを取得した場合、実際の獲得値が2として加算される。
- セレブから他スタイルへ変更すると経験値倍率が解除される。
- スタイルを複数回切り替えても、同時に有効な効果が1種類のみである。

## 未確定事項・確認事項
- SPD倍率は `PlayerController` 側で `MoveSpeed` 設定時に補正する方針で確定。
- セレブ効果は `PlayerExperience` 内で倍率を保持し、`AddExperience` で適用する方針で確定。
- 巫女効果の30秒は「ゲーム内経過時間（`Time.deltaTime`）」基準で扱う前提。ポーズ中の経過扱いは本要件では進行しない仕様とする。
