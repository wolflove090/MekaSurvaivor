# 回復アイテム生成機能 要件書

## 背景と目的
戦闘中にプレイヤーがHPを補填できる導線を追加するため、破壊可能なフィールドオブジェクトから回復アイテムを生成する。
既存の経験値オーブ取得形式を流用し、追加コストを抑えつつ取得体験を統一する。

## スコープ内
- フィールドに「破壊可能オブジェクト（以下、オブジェクト）」をランダム配置する。
- オブジェクトはダメージを受けると破壊され、回復アイテムを1つ生成する。
- 回復アイテムは経験値オーブと同じ追従/取得形式で取得できる。
- 回復アイテム取得時、プレイヤーHPを3回復する。
- オブジェクト生成には以下制約を適用する。
  - 生成位置はカメラに写っていない。
  - 生成位置はカメラ外縁から約10px外側の帯域を優先する。
  - 10pxオフセットの方向はXZ平面でランダムとする。
  - 生成間隔は30秒。
  - フィールド上の同時存在上限は3つ。
- オートロック系攻撃のターゲット優先度では、オブジェクトを最下位にする。

## スコープ外
- 回復量（3）およびスポーン間隔（30秒）のバランス調整UI実装。
- 回復アイテムの演出（SE/VFX）追加。
- セーブ/ロードをまたぐオブジェクト永続化。
- 敵攻撃によるオブジェクト破壊仕様の追加。

## 機能要件
1. 破壊可能オブジェクト
- オブジェクトは `IDamageable` を実装し、プレイヤー武器からのダメージでHPが0以下になると破壊される。
- オブジェクトの初期HPは1固定とする。
- 破壊時に自身をフィールド管理対象から外し、回復アイテムを1つ生成する。

2. オートロック優先度
- 自動照準を行う武器は、可視範囲内に敵が存在する場合は常に敵を優先して攻撃する。
- 攻撃対象として敵が存在しない場合のみ、オブジェクトを攻撃対象として選択できる。
- この優先度は「敵 > オブジェクト（最下位）」とし、同カテゴリ内は既存の最短距離ロジックを維持する。

3. オブジェクトのランダム生成
- 生成管理コンポーネントは30秒ごとに生成判定を行う。
- フィールド上の生存オブジェクト数が3未満のときのみ生成する。
- 生成位置は以下条件を同時に満たす。
  - メインカメラのビューポート外である。
  - メインカメラのスクリーン境界から約10px外側（外縁近傍）に相当するワールド位置である。
  - 10pxオフセットの方向はXZ平面でランダムに決定する。
- 条件を満たす位置が見つからない場合、その周期は生成を見送り、次周期で再試行する。

4. 回復アイテム取得
- 回復アイテムは経験値オーブ同様、プレイヤー接近で追従し、取得距離で回収される。
- 取得時にプレイヤーの `HealthComponent.Heal(3)` を呼び出す。
- 取得後はオブジェクトプールへ返却する（未プール時は破棄）。

## 非機能要件
- 既存コード規約（暗黙private、`_camelCase`、公開APIのドキュメントコメント）を順守する。
- 既存のオブジェクトプール実装方針（`ObjectPool<T>` + `PooledObject`）を踏襲する。
- 生成管理は毎フレームGCを極力発生させない実装とする（再利用バッファを使う）。
- null参照と未設定参照は警告ログで検出可能にする。

## 受け入れ条件
- フィールド上にオブジェクトが最大3つまでしか存在しない。
- オブジェクト生成判定は30秒間隔で行われる。
- 生成されたオブジェクト位置は、生成時点でカメラ画面外かつカメラ外縁から約10px付近にある。
- オブジェクト生成時、10pxのオフセット方向はXZ平面でランダムに決定される。
- オブジェクトにダメージを与えて破壊すると、回復アイテムが1つ生成される。
- プレイヤーが回復アイテムを取得するとHPが3回復し、最大HPを超えない。
- 自動照準武器は、敵がいる状況でオブジェクトを攻撃対象に選ばない。
