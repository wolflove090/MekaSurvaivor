# インゲーム帰還導線 要件書

## 背景と目的
- 現在のサバイバーゲームは `GameManager` がゲームクリア時、`PlayerController` 経由でゲームオーバー時に `Time.timeScale = 0f` を設定して停止するが、その後の導線が存在しない。
- プレイ終了後に結果を確認し、ホーム画面へ戻れるようにして、1プレイごとの区切りを成立させる。
- ホーム復帰後に既存の「出撃」導線を再利用し、連続して再プレイできる状態にする。

## スコープ内
- ゲームオーバー時とゲームクリア時に共通のリザルトUIを表示する。
- リザルトUIに「撤退」の文言、今回のプレイでの撃破数、ホーム遷移ボタンを表示する。
- リザルトUIのホーム遷移ボタン押下で `Assets/Home/Home.unity` へ戻る導線を追加する。
- ホーム遷移時またはホーム復帰前に `Time.timeScale` を通常値へ戻し、ホーム復帰後に再度 `Assets/Survaivor/Main.unity` をプレイできる状態にする。

## スコープ外
- リザルトUIにリトライボタンや追加統計（討伐数、到達時間、レベル詳細など）を追加すること。
- ホーム画面側のレイアウトや「出撃」以外のボタン挙動の改修。
- 経験値をホーム画面の恒久的な育成値として保存するセーブ機能。
- フェード、アニメーション、サウンドなどの演出追加。
- ゲームオーバー時とゲームクリア時で別デザインの結果画面を作り分けること。

## 機能要件
1. 終了時のリザルト表示
- `GameMessageBus` のゲームクリア通知またはゲームオーバー通知を契機に、インゲーム中のUI上へリザルトUIを表示する。
- リザルトUI表示後も、既存HUDが残っていても操作不能や表示破綻を起こさず、プレイ継続操作ができない終了状態を維持する。
- ゲームクリアとゲームオーバーのどちらでも、同じ導線でリザルトUIが1回だけ表示される。

2. リザルトUIの表示内容
- リザルトUIには固定文言として「撤退」を表示する。
- リザルトUIには、そのプレイでプレイヤーが撃破した敵数の合計値を数値で表示する。
- リザルトUIには、ラベル「ホームへ」を表示するホーム画面遷移ボタンを1つ表示する。
- リザルトUIの各表示要素は、既存のUI Toolkitベースのゲーム画面UIに追加し、未設定時に無言で欠落しないよう参照不備を検知できる構成にする。

3. 撃破数の集計
- 表示する値は、そのプレイ中に撃破した敵の累計数として扱う。
- `EnemyDied` 相当の敵死亡通知を基準に、実際に倒された敵のみを1件ずつ加算する。
- リザルト表示用の撃破数は1プレイ単位で管理し、シーン再開時に0件から再集計される。

4. ホーム遷移導線
- リザルトUIのホーム遷移ボタン押下で、現在のサバイバーゲームシーンから `Assets/Home/Home.unity` 相当のホームシーンへ遷移できる。
- ホーム遷移は多重押下で複数回実行されないように制御する。
- ホームシーン参照が解決できない場合は、原因を追跡できるログまたは警告を出す。

5. 再プレイ可能状態の復元
- ホーム遷移前、またはホームシーン復帰前に `Time.timeScale` を `1f` へ戻す。
- ホーム復帰後に既存の `HomeScreenUiController` の「出撃」ボタンから再度 `Main` シーンへ遷移し、通常どおりゲームを開始できる。
- 前回プレイのリザルト表示状態や撃破数集計値は、次回プレイ開始時に持ち越されない。

## 非機能要件
- 既存コード規約（暗黙private、`_camelCase`、公開APIのドキュメントコメント）を順守する。
- 既存の UI Toolkit 構成（`GameScreenUiController` とその UXML / USS）をベースに最小限の改修で対応し、既存HUD更新を壊さない。
- ゲーム終了判定そのもの（`GameManager` / `GameSessionService` / `PlayerController` の勝敗条件）は変更しない。
- 追加する状態管理は1プレイ単位のランタイム情報に留め、別シーンへ永続化しない。
- ホームとインゲームのシーン往復を繰り返しても、`Time.timeScale` の戻し忘れや多重購読で不安定化しない。

## 受け入れ条件
- `Assets/Survaivor/Main.unity` でゲームオーバーになると、画面上に「撤退」、累計撃破数、「ホームへ」ボタンを含むリザルトUIが表示される。
- `Assets/Survaivor/Main.unity` でゲームクリアになっても、同様のリザルトUIが表示される。
- リザルトUI上のホーム遷移ボタン押下で `Assets/Home/Home.unity` に戻る。
- ホーム復帰直後に `Time.timeScale` が 0 のまま残らず、ホーム画面の操作が正常に行える。
- ホーム復帰後に「出撃」ボタンを押すと再度 `Assets/Survaivor/Main.unity` を通常どおり開始できる。
- 次のプレイ開始時、前回プレイの撃破数表示やリザルト表示状態が残存しない。

## 未確定事項・確認事項
- 現状の撃破通知は `GameMessageBus` に存在するため、どのクラスで1プレイ分の撃破数を保持し、リザルトUIへ受け渡すかを実装計画で具体化する必要がある。
