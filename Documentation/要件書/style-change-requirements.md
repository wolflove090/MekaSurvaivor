# スタイル変更機能 要件書

## 背景と目的
プレイヤーレベルの進行にあわせて成長選択を追加し、一定レベルごとにスタイル変更を選択できるようにする。既存の武器強化UIを流用しつつ、選択結果を `CharacterStatsData` としてプレイヤーへ反映する。
また、選択したスタイルに応じてプレイヤー見た目の画像（スプライト）も切り替え、見た目と性能を一致させる。

## スコープ内
- プレイヤーレベルが4,7,10...（`LevelUpUiDisplayRule` 準拠）に到達したときにスタイル変更UIを表示する。
- UI形式は既存の武器強化UI（3カード構成）を使い回す。
- スタイル変更時のみ選択肢を「巫女」「アイドル」「セレブ」の3つに変更する。
    - 通常のレベルアップ時は武器の強化選択肢を表示します。
- スタイル選択時に該当 `CharacterStatsData`（ScriptableObject）をプレイヤーへ適用する。
- 適用後、プレイヤーの参照ステータス（HP/POW/DEF/SPD）をゲーム内挙動へ反映する。
- スタイル選択時に該当スタイル画像へプレイヤー表示を切り替える。
- 移動による向き変更は左右反転で表現し、向き変更時には画像差し替えを行わない。
- デフォルト向きは右方向とし、各スタイルの右向き画像を基準アセットとして保持する。

## 機能要件
1. `GameEvents.OnPlayerLevelUp` 受信時、到達レベルが4,7,10...の場合のみスタイル変更UIを開く。
2. UIカードは既存3枠を利用し、カード表示内容をスタイル選択用に置き換える。
3. カード選択肢は以下3種類とする。
- 巫女: HP 15 / POW 1 / DEF 0 / SPD 5
- アイドル: HP 10 / POW 1 / DEF 0 / SPD 8
- セレブ: HP 10 / POW 3 / DEF 0 / SPD 5
4. 選択したスタイルに対応する `CharacterStatsData` をプレイヤーへ適用する。
5. UI表示中は既存の武器強化UIと同様にゲーム進行を停止し、選択完了後に再開する。
6. スタイル選択確定時、プレイヤーの左右向きスプライトを選択スタイルに対応する画像セットへ切り替える。
7. スタイル画像参照は Inspector で設定可能にし、未設定時は現在の画像を維持して警告ログを出す。
8. 画像切り替えはステータス適用と同一タイミングで実行し、片方のみ更新される不整合を防ぐ。
9. 移動方向による向き変更は `SpriteRenderer.flipX` 等の左右反転で実装し、向き変更時は画像アセットを差し替えない。
10. スタイル画像適用時は右向き画像を `SpriteRenderer.sprite` に設定し、左向きは `flipX` による反転表示で表現する。

## 非機能要件
- 既存UXML/USS構造を破壊しない。
- 既存コード規約（暗黙private、`_camelCase`、ドキュメントコメント）を守る。
- 参照未設定時はnullガードで安全に処理する。
- スタイル画像切り替え時に不要な `Resources.Load` を増やさず、既存参照（SerializeField）ベースで処理する。
- 画像切り替え後も既存の左右反転制御（向き更新）を壊さない。
- 向き変更処理は毎フレーム新規画像を読み込まない。
- デフォルト状態（スポーン直後/スタイル変更直後）は右向き表示を維持する。

## 受け入れ条件
- レベル3ではスタイルUIが表示されず、レベル4で表示される。
- レベルが4,7,10...以外の場合は通常の武器強化UIが表示される。
- 表示カードが「巫女」「アイドル」「セレブ」になっている。
- いずれかを選ぶとプレイヤーへ対応 `CharacterStatsData` が反映される。
- スタイル変更時は「消費したHP量」を維持して現在HPを再計算する（例: `5/10 -> 10/15`）。
- いずれかを選ぶと、プレイヤー画像が対応スタイル（巫女/アイドル/セレブ）へ即時切り替わる。
- 切り替え後も移動方向に応じた左右向き画像が正しく表示される。
- 向き変更時は左右反転のみが発生し、画像アセットの再差し替えは発生しない。
- スタイル変更直後は右向き画像が表示され、左移動時のみ左右反転で表示が切り替わる。
- スタイル画像参照が未設定でも処理が停止せず、警告ログのみ出力される。
- 選択後にUIが閉じ、ゲームが再開される。

## 未確定事項・確認事項
- スタイル画像アセット対応表（確認済み）
  - 巫女: `Assets/GameResources/Player/Styles/miko.png`
  - アイドル: `Assets/GameResources/Player/Styles/idol.png`
  - セレブ: `Assets/GameResources/Player/Styles/celebrity.png`
